<!DOCTYPE html>
<html>
<head>
  <title>B R E A K I N G * β α ∆</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="subresource" href="css/light.css" />
  <link rel="subresource" href="css/dark.css" />
  <link rel="icon" type="image/png" href="path/to/favicon.png">
</head>
<body>
  <div id="chat-container"></div>
  <div id="transcription"></div>

  <script>
    const socket = new WebSocket('ws://localhost:9001/transcribe');
  
    socket.addEventListener('open', () => {
      console.log('WebSocket connection established');
      // Start sending audio data if applicable
    });
  
    socket.addEventListener('message', (event) => {
      const transcribedText = event.data;
      document.getElementById('transcription').textContent = transcribedText;
      handleSubmit(transcribedText);
    });
  
    socket.addEventListener('close', () => {
      console.log('WebSocket connection closed');
    });
  </script>

  <script type="text/babel">
    const ChatComponent = () => {
        const [query, setQuery] = React.useState('');
        const [result, setResult] = React.useState('');

        const handleSubmit = async (e) => {
            e.preventDefault();
            try {
                updateChatMessages(query, true); 
                setQuery(''); 

                console.log('Sending query:', query);
                const response = await fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query })
                });

                if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
                }

                const data = await response.json();
                console.log('Received response:', data);
                updateChatMessages(data.result); 
            } catch (error) {
                console.error('Error:', error);
                updateChatMessages(`Error: ${error.message}`);
            }
        };

        const updateChatMessages = (newMessage, isUser = false) => {
            setResult((prevResult) => {
                const timestamp = new Date().toLocaleTimeString();
                const sender = isUser ? 'USER:' : 'WALTER:';
                const message = `${timestamp} ${sender}: ${newMessage}`;
                return `${prevResult}\n${message}`;
            });
            };

        return (
            <div className="chat-container">
            <div className="chat-result">
                {result.split('\n').map((message, index) => {
                    const [timestamp, sender, content] = message.split(': ');
                    return (
                        <div key={index} className={sender === 'USER' ? 'user-message' : 'agent-message'}>
                            <strong>{timestamp} {sender}</strong> {content}
                        </div>
                    );
                })}
            </div>
            <div className="chat-input">
                <form onSubmit={handleSubmit}>
                <input
                    type="text"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    placeholder="START"
                />
                <button type="submit">SUBMIT</button>
                </form>
            </div>
            </div>
        );
    };

    ReactDOM.render(<ChatComponent />, document.getElementById('chat-container'));
  </script>

  <!-- NGL -->
  <script src="../dist/ngl.js"></script>

  <!-- UI -->
  <script src="js/lib/signals.min.js"></script>
  <script src="js/lib/tether.min.js"></script>
  <script src="js/lib/colorpicker.min.js"></script>
  <script src="js/ui/ui.js"></script>
  <script src="js/ui/ui.extra.js"></script>
  <script src="js/ui/ui.ngl.js"></script>
  <script src="js/gui.js"></script>
  
  <!-- NGL Viewer setup -->
  <script>
    NGL.cssDirectory = "css/"
    NGL.documentationUrl = "../build/docs/"
    NGL.examplesListUrl = "../build/scriptsList.json"
    NGL.examplesScriptUrl = "./scripts/"

    // Datasources
    NGL.DatasourceRegistry.add("data", new NGL.StaticDatasource("../data/"))
    var mdsrv = NGL.getQuery("mdsrv")
    if (mdsrv) {
      var mdsrvDatasource = new NGL.MdsrvDatasource(mdsrv)
      NGL.DatasourceRegistry.add("file", mdsrvDatasource)
      NGL.setListingDatasource(mdsrvDatasource)
      NGL.setTrajectoryDatasource(mdsrvDatasource)
    }

    var stage
    document.addEventListener("DOMContentLoaded", function () {
      stage = new NGL.Stage()
      NGL.StageWidget(stage)

      var load = NGL.getQuery("load")
      if (load) stage.loadFile(load, {defaultRepresentation: true})

      var script = NGL.getQuery("script")
      if (script) stage.loadScript("./scripts/" + script + ".js")

      var struc = NGL.getQuery("struc")
      var traj = NGL.getQuery("traj")
      if (struc) {
        stage.loadFile(struc, {
          defaultRepresentation: true
        }).then(function(o) {
          if (traj) o.addTrajectory(traj)
        })
      }
    })
  </script>
</body>
</html>
